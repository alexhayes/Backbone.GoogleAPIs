<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Backbone.GoogleDrive | Test Console</title>

    <script type="text/javascript"
            src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
    <script type="text/javascript"
            src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
    <script type="text/javascript"
            src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript"
            src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>

    <script type="text/javascript" src="./backbone.googledrive.js"></script>

    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css"/>
    <script type="text/javascript" async="true" src="https://apis.google.com/js/client:plusone.js"></script>
    <script type="text/javascript">
        var signinCallback = function (json) {
            json = json || {};

            Backbone.GoogleDrive.AccessToken = json["access_token"];

            _.defer(fetchUserInfo, true);

            try {
                Backbone.history.start();
            } catch (e) {
                console.warn(e);
            }
        };
    </script>
</head>
<body>
<div class="jumbotron">
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <h4>Backbone.GoogleDrive</h4>
                <h5>Test Console</h5>

                <p><a class="btn btn-primary btn-sm" role="button"
                      href="https://github.com/hrovira/Backbone.GoogleDrive" target="_blank">API documentation</a></p>
            </div>
            <div class="col-md-6">
                <h5>Javascript Dependencies</h5>
                <ul class="nav nav-list deps-container">
                </ul>
            </div>
            <div class="well col-md-3">
                <!-- HELLO! -->
                <!-- This 'client_id' will only work from my domain. -->
                <!-- If you are forking this project, you should replace with your own 'client_id' -->
                <!-- Go to https://console.developers.google.com/project, create a project, and generate a 'client_id' -->
                <div class="signed-out">
                    <span id="signinButton">
                        <span class="g-signin"
                              data-callback="signinCallback"
                              data-clientid="735622011915-e988pa3i31rboijnurmmk5tsgv32v8me.apps.googleusercontent.com"
                              data-cookiepolicy="single_host_origin"
                              data-requestvisibleactions="http://schemas.google.com/AddActivity"
                              data-scope="https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile">
                        </span>
                    </span>
                </div>
                <div class="signed-in hide">
                    <img class="signed-in-picture" src="" style="width: 50px;"/>
                    <h6><small>Signed in as</small></h6>
                    <h6 class="signed-in-email"></h6>
                    <a class="btn btn-sm btn-danger" href="#sign-out">Sign Out</a>
                    <a class="btn btn-sm" href="https://accounts.google.com/b/0/IssuedAuthSubTokens" target="_blank">Revoke access</a>
                </div>
            </div>
        </div>

        <a href="https://github.com/hrovira/Backbone.GoogleDrive" target="_blank">
            <img style="position: absolute; top: 0; right: 0; border: 0;"
                 src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67"
                 alt="Fork me on GitHub"
                 data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png">
        </a>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="col-md-3">
            <div class="list-group top-level-anchors">
                <a href="#" class="list-group-item list-group-item-info" onclick="return false;">
                    <h5 class="list-group-item-heading">Example Operations</h5>
                </a>
                <a class="list-group-item" href="#about">About</a>
                <a class="list-group-item" href="#list-apps">Apps</a>
                <a class="list-group-item" href="#list-folders">List Folders</a>
                <a class="list-group-item" href="#list-changes">Poll ChangeList</a>
                <a class="list-group-item" href="#userinfo">Get User Info</a>
            </div>
            <div class="list-group top-level-anchors">
                <a href="#" class="list-group-item list-group-item-info active" onclick="return false;">
                    <h5 class="list-group-item-heading">File Operations</h5>
                </a>
                <a class="list-group-item file-insert" href="#file-insert">Insert File</a>
                <a class="list-group-item file-fetch" href="#file-fetch">Fetch File</a>
                <a class="list-group-item file-update" href="#file-update">Update File</a>
                <a class="list-group-item file-trash" href="#file-trash">Trash File</a>
            </div>
        </div>
        <div class="col-md-8">
            <div class="panel panel-primary">
                <div class="panel-body">
                    <h5>Javascript</h5>
                    <pre class="code-container pre-scrollable"><--- Select one of the example operations to begin</pre>
                    <h5>Model Contents after HTTP Response</h5>
                    <pre class="json-container pre-scrollable"></pre>
                    <h5>Errors</h5>

                    <div class="error-container well pre-scrollable"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    // shared among File operations after insert
    var FileId;

    // displays JS dependencies
    _.defer(function () {
        _.each($("script"), function (script) {
            if (script && _.has(script, "src")) {
                if (script["src"].indexOf("chrome-extension") >= 0) return;
                if (script["src"].indexOf("apps-static") >= 0) return;
                $(".deps-container").append("<li>" + script["src"] + "</li>");
            }
        });
    });

    // support functions
    var displayJson = function (m) {
        $(".json-container").html(JSON.stringify(m.toJSON(), undefined, 2));
    };

    var displayError = function (model, response) {
        $(".error-container").html(response.responseText);
    };

    // example functions
    var fetchUserInfo = function (onStartup) {
        var model = new Backbone.GoogleDrive.Model({});
        if (!onStartup) {
            model.on("error", displayError);
            model.on("change", displayJson);
        }
        model.on("change", function (m) {
            $(".signed-in-picture").attr("src", m.get("picture"));
            $(".signed-in-email").html(m.get("email"));
            $(".signed-in").removeClass("hide");
            $(".signed-out").addClass("hide");
        });
        model.fetch({ "url": "https://www.googleapis.com/oauth2/v1/userinfo" });
    };

    var fetchAbout = function () {
        var model = new Backbone.GoogleDrive.Model({ "kind": "drive#about" });
        model.on("change", displayJson);
        model.on("error", displayError);
        model.fetch();
    };

    var pollChangeList = function () {
        var model = new Backbone.GoogleDrive.ChangeList();
        model.on("change", displayJson);
        model.on("error", displayError);
        model.poll();
    };

    var listApps = function () {
        var model = new Backbone.GoogleDrive.List({ "kind": "drive#appList" });
        model.on("change", displayJson);
        model.on("error", displayError);
        model.list();
    };

    var listFolders = function () {
        var model = new Backbone.GoogleDrive.List({ "kind": "drive#fileList" });
        model.on("change", displayJson);
        model.on("error", displayError);
        model.list({ "q": "mimeType='application/vnd.google-apps.folder'" });
    };

    var fileInsert = function () {
        var model = new Backbone.GoogleDrive.File({
            "title": "Backbone.GoogleDrive | Test"
        });
        model.on("change:id", function (m) {
            FileId = m.get("id");
        });
        model.on("change", displayJson);
        model.on("error", displayError);
        model.insert();
    };

    var fileFetch = function () {
        if (!FileId) return $(".error-container").html("Insert File First");

        var model = new Backbone.GoogleDrive.File({ "id": FileId });
        model.on("change", displayJson);
        model.on("error", displayError);
        model.fetch();
    };

    var fileUpdate = function () {
        if (!FileId) return $(".error-container").html("Insert File First");

        var model = new Backbone.GoogleDrive.File();
        model.set("id", FileId);
        model.set("title", "Backbone.GoogleDrive | Test | New Title");
        model.on("change", displayJson);
        model.on("error", displayError);
        model.update();
    };

    var fileTrash = function () {
        if (!FileId) return $(".error-container").html("Insert File First");

        var model = new Backbone.GoogleDrive.File({ "id": FileId });
        model.on("change", displayJson);
        model.on("error", displayError);
        model.trash();
    };

    // bootstraps example functions
    App = Backbone.Router.extend({
        "__route": function(name, target_fn) {
            var wrapping_fn = function () {
                if (_.isFunction(target_fn)) _.defer(target_fn);

                $(".json-container").empty();
                $(".error-container").empty();

                // pretty printing target_fn
                var strFn = "" + target_fn;
                var parts = [];

                if (strFn.indexOf("FileId") >= 0) parts.push("var FileId = \"" + (FileId || "") + "\";");
                parts.push("" + strFn);
                if (strFn.indexOf("displayJson") >= 0) parts.push("var displayJson = " + displayJson + ";");
                if (strFn.indexOf("displayError") >= 0) parts.push("var displayError = " + displayError + ";");
                $(".code-container").html(parts.join("\n\n"));
            };

            this.route(name, name, wrapping_fn);
        },

        "__toggle_active": function(href) {
            _.defer(function () {
                _.each($(".top-level-anchors").find("a.list-group-item"), function (item) {
                    $(item).removeClass("active");
                    if (_.isEqual($(item).attr("href"), "#" + href)) $(item).addClass("active");
                });
            });
        }
    });
    app = new App();
    app.on("route", app.__toggle_active);
    app.__route("userinfo", fetchUserInfo);
    app.__route("about", fetchAbout);
    app.__route("list-apps", listApps);
    app.__route("list-folders", listFolders);
    app.__route("list-changes", pollChangeList);
    app.__route("file-insert", fileInsert);
    app.__route("file-fetch", fileFetch);
    app.__route("file-update", fileUpdate);
    app.__route("file-trash", fileTrash);
    app.route("sign-out", "sign-out", function() {
        if (_.isEmpty(Backbone.GoogleDrive.AccessToken)) {
            document.location = document.location.href.replace("#sign-out", "");
            return;
        }

        var po = document.createElement("script");
        po["type"] = "text/javascript";
        po["async"] = true;
        po["src"] = "https://accounts.google.com/o/oauth2/revoke?token=" + Backbone.GoogleDrive.AccessToken;
        po["onload"] = function() {
            document.location = document.location.href.replace("#sign-out", "");
        };

        var s = document.getElementsByTagName("script")[0];
        s["parentNode"].insertBefore(po, s);
    });
</script>
</body>
</html>